# メタデータについて

## メタデータファイル構造

ヘッダ部、リネームエントリ部、メタデータエントリ部、追記部を順に連結した構成にする。  
追記部については存在しないこともある。（基本的に動作中以外は存在させない。）  

各エントリは16バイト単位になるように後ろを0埋めする。  
（フィールドで16バイト単位になるように設計してある。）  

文字列についてはUTF-16で格納し、そのサイズはsizeof(char16_t)単位で表すこととする。  
フィールドについては16バイト単位で整列する。

### ヘッダ部

```text
  0   1   2   3   4   5   6   7   8   9   A   B   C   D   E   F
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|   signature   |    version    |           data size           |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|   offset to rename section    |    size of rename section     |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|   number of rename entries    | reserved (0)  | reserved (0)  |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|  offset to metadata section   |   size of metadata section    |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|  number of metadata entries   | reserved (0)  | reserved (0)  |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
```

signatureは"MFMD"。  
versionは0x00020000。  
offset to X sectionはファイル先頭からのバイト単位での位置。  
size of X sectionはそのセクション全体のバイト単位でのサイズ。  

data sizeは追記部を除くバイト単位のファイルサイズ。  

### リネームエントリ部

```text
  0   1   2   3   4   5   6   7   8   9   A   B   C   D   E   F
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|  block size   | reserved (0)  |   size of A   |   size of B   |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                      A (variable length)                      |
+---------------------------------------------------------------+
|                      B (variable length)                      |
+---------------------------------------------------------------+
```

Aが実体（元）のファイル名、Bが変更後のファイル名。  
リネームエントリ部では再帰的に（複数のエントリを繋げて）解決することはない。  

AおよびBは16バイト単位で整列する。  
size of Aおよびsize of Bは整列前の数値。  
size of Aおよびsize of Bはsizeof(wchar_t)単位。  

block sizeはエントリ全体（block size自身からBまで）のバイト単位のサイズ。  

**追記部でのみの仕様：**Bを空文字列にすると、エントリが削除されたことを表す。  

Bが空文字列の場合、またはAとBが同じ場合はエントリを追加しない。  

### メタデータエントリ部

```text
  0   1   2   3   4   5   6   7   8   9   A   B   C   D   E   F
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|  block size   | reserved (0)  | filename size | security size |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|     flag      |   attribute   |         creation time         |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|       last access time        |        last write time        |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                  filename (variable length)                   |
+---------------------------------------------------------------+
|                  security (variable length)                   |
+---------------------------------------------------------------+
```

flagは有効なフィールドを示すフラグ。  

| 値 |          意味           |
|:--:|:-----------------------:|
|0x01|(reserved for future use)|
|0x02|attribute                |
|0x04|creation time            |
|0x08|last access time         |
|0x10|last write time          |
|0x20|security                 |

filenameは実体（リネーム前）のファイル名。  
securityは現在なし。すなわちsecurity sizeは0でsecurityは0バイト。  

filenameおよびsecurityは16バイト単位で整列する。  
filename sizeおよびsecurity sizeは整列前の数値。  
filename sizeはsizeof(wchar_t)単位。  

block sizeはエントリ全体（block size自身からsecurityまで）のバイト単位のサイズ。  

**追記部でのみの仕様：**flagを0にすると、エントリが削除されたことを表す。  

flagが0の場合は、エントリを追加しない。  

### 追記部

動作中にリネームやメタデータの変更があった際に記録するためのセクション。  
起動時と終了時にリネームエントリ部やメタデータエントリ部に統合して追記部は削除する。  

```text
  0   1   2   3   4   5   6   7   8   9   A   B   C   D   E   F
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|  block size   | reserved (0)  |   data type   | reserved (0)  |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                    data (variable length)                     |
+---------------------------------------------------------------+
```

block sizeはエントリ全体（block size自身からdataまで）のバイト単位のサイズ。  
data type、dataについては以下を参照。  

#### リネーム情報

data type = 1  
dataはリネームエントリ部のエントリと同じ情報。  

#### メタデータ情報

data type = 2  
dataはメタデータエントリ部のエントリと同じ情報。  

## 処理方法

### 起動時

メタデータファイルの追記部を無視してメモリ上にデータを構築し、次に追記部があればその情報を先頭のものから順に適用する。  
元のメタデータファイルに追記部があった場合は、メモリに構築したデータを元に追記部の存在しないファイルに上書きする。  

### メタデータ更新時

メモリ上の情報を更新した後、メタデータファイルには追記モードで追記部を記述する。  

### 終了時

追記部を統合して（追記部が存在しない状態にして）メタデータファイルを全更新する。  
ここではメモリ上のデータをそのまま書き出せば求めるファイルにできるはず。  

起動時にも統合作業を行っているが、あちらは終了時の処理が行われなかった場合の保険。  

## 備考

### この方法はスケールしますか

主に統合作業においてスケールしません。  
メタデータの更新やリネームが行われるファイルはかなり多く見積もっても1000程度だと想定しているため、この程度の実装で十分だと考えています。  

### なぜ16バイト単位なのですか

バイナリエディタで見やすいようと、メモリアラインの関係です。  
容量を食うようならば考え直します。  
